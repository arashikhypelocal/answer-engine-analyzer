<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AEO Extractor</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0b1222;--panel:#0f172a;--border:#1f2937;--text:#e5e7eb;--sub:#94a3b8;--brand:#22d3ee;
  }
  body{margin:0;background:linear-gradient(180deg,#0a0f1f 0,#0b1222 50%,#0a0f1f);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 8px}
  .card{background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
  .muted{color:var(--sub)}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  input[type=file], textarea, input[type=number], input[type=text]{background:#0a0f1f;color:var(--text);
    border:1px solid var(--border);border-radius:10px;padding:10px}
  textarea{width:100%;min-height:140px}
  .btn{cursor:pointer;border-radius:10px;border:1px solid var(--border);background:#111827;color:var(--text);
    padding:10px 14px}
  .btn.primary{background:linear-gradient(180deg,#0891b2,#0e7490);border-color:#0e7490}
  .btn.warn{background:linear-gradient(180deg,#7c2d12,#b45309)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #155e75;border-radius:999px;
    color:#7dd3fc;background:rgba(8,145,178,.12);font-size:12px}
  .status{margin-top:8px}
  .downloads .btn{white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>AEO Extractor</h1>
  <div class="muted">All processing is done in your browser</div>

  <!-- INPUT -->
  <div class="card">
    <h3>1) Provide Input</h3>
    <div class="grid">
      <div>
        <div><strong>Upload .txt</strong></div>
        <input id="fileInput" type="file" accept=".txt">
      </div>
      <div>
        <div><strong>Or paste raw text</strong></div>
        <textarea id="pasteArea" placeholder='{
    "title": "Best Calgary Roofing Companies",
    "create_time": 1755790426.905536,
    "update_time": 1755790438.622881,
    "mapping": {'></textarea>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="runExtract">Run Extraction</button>
      <button class="btn" id="resetBtn">Reset</button>
      <span class="pill" id="inputInfo">no input loaded</span>
    </div>
    <div class="status muted" id="extractStatus"></div>
  </div>

  <!-- EXTRACTOR OUTPUT -->
  <div class="card">
    <h3>2) Extracted Output</h3>
    <div class="row downloads">
      <button class="btn" id="dlExtracted">Download extracted.txt</button>
    </div>
    <details style="margin-top:10px">
      <summary><strong>Preview (first 2000 chars)</strong></summary>
      <pre id="extractedPreview" style="white-space:pre-wrap"></pre>
    </details>
  </div>

  <!-- NGRAMS -->
  <div class="card">
    <h3>3) N-grams (from extracted content only — excludes URLs)</h3>
    <div class="row" style="margin-bottom:10px">
      <label>Top K <input id="topK" type="number" min="1" value="50" style="width:90px"></label>
      <label>Min Freq <input id="minFreq" type="number" min="1" value="1" style="width:90px"></label>
      <label>Extra stopwords (comma) <input id="extraStop" type="text" placeholder="dxp,cms" style="width:220px"></label>
      <label>Blacklist tokens (comma) <input id="extraBlack" type="text" placeholder="title,snippet" style="width:220px"></label>
      <button class="btn primary" id="runNgrams">Run N-grams</button>
    </div>
    <div class="row downloads">
      <button class="btn" id="dlBi">bigrams.csv</button>
      <button class="btn" id="dlTri">trigrams.csv</button>
      <button class="btn" id="dlFour">fourgrams.csv</button>
    </div>
    <div class="status muted" id="ngStatus"></div>
    <div class="grid" style="margin-top:10px">
      <div>
        <h4>Bigrams</h4>
        <table><thead><tr><th>phrase</th><th>freq</th></tr></thead><tbody id="tblBi"></tbody></table>
      </div>
      <div>
        <h4>Trigrams</h4>
        <table><thead><tr><th>phrase</th><th>freq</th></tr></thead><tbody id="tblTri"></tbody></table>
      </div>
    </div>
    <div style="margin-top:12px">
      <h4>4-grams</h4>
      <table><thead><tr><th>phrase</th><th>freq</th></tr></thead><tbody id="tblFour"></tbody></table>
    </div>
  </div>
</div>

<script>
/* ----------------- Config & Patterns ----------------- */
const KEYS = ["title","url","snippet","matched_text","alt"];
const PAIR_RE = new RegExp(String.raw`^\s*"?` +
  `(title|url|snippet|matched_text|alt)` +
  String.raw`"?\s*:\s*(["“])(.*?)(["”])\s*,?\s*$`, "i");

const URL_RE   = /https?:\/\/\S+|www\.\S+/gi;
const EMAIL_RE = /\b[\w.-]+@[\w.-]+\.\w+\b/g;
const TOKEN_RE = /\b[a-zA-Z]{2,}\b/g;

const DEFAULT_STOP = new Set([
 "a","an","the","and","or","but","if","then","else","when","while","for","to","from",
 "in","on","at","by","of","off","over","under","with","without","within","into","out",
 "is","am","are","was","were","be","been","being","do","does","did","doing","have","has","had",
 "i","you","he","she","it","we","they","me","him","her","them","my","your","his","its","our","their",
 "as","that","this","these","those","there","here","so","than","too","very","can","cannot","could",
 "should","would","may","might","must","will","just","not","no","yes","also"
]);
const DEFAULT_BLACK = new Set(["http","https","www","com","url","chatgpt","utm","source","amp","html","pdf","title","snippet"]);

/* ----------------- State ----------------- */
let rawText = "";
let extractedDict = null;
let extractedTxt = "";  // combined extracted.txt content
let caches = { bi:[], tri:[], four:[] };

/* ----------------- Utils ----------------- */
function escapeHtml(s){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function dedupeKeepOrder(arr){ const seen=new Set(), out=[]; for(const v of arr){ if(!seen.has(v)){ seen.add(v); out.push(v); } } return out; }
function blobDownload(filename, data, mime){ const url = URL.createObjectURL(new Blob([data], {type:mime||'text/plain'})); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1500); }

/* ----------------- Extraction ----------------- */
function extractPairs(text){
  const res = { title:[], url:[], snippet:[], matched_text:[], alt:[] };
  const lines = text.split(/\r?\n/);
  for(const line of lines){
    const m = line.match(PAIR_RE);
    if(m){
      const key = m[1].toLowerCase();
      let val = (m[3]||"").trim().replace(/[“”]/g,'"');
      res[key].push(val);
    }
  }
  // dedupe
  for(const k of KEYS){ res[k] = dedupeKeepOrder(res[k]); }
  return res;
}
function sectionedText(results){
  const out=[];
  for(const k of KEYS){
    for(const v of results[k]) out.push(`${k}: ${v}`);
    out.push("");
  }
  return out.join("\n");
}

/* ----------------- N-grams ----------------- */
function cleanAndTokenize(text, extraStop=[], extraBlack=[]){
  text = text.replace(URL_RE," ").replace(EMAIL_RE," ").toLowerCase().replaceAll("-"," ");
  const tokens = (text.match(TOKEN_RE) || []);
  const stop = new Set([...DEFAULT_STOP, ...extraStop.map(s=>s.trim().toLowerCase()).filter(Boolean)]);
  const black= new Set([...DEFAULT_BLACK, ...extraBlack.map(s=>s.trim().toLowerCase()).filter(Boolean)]);
  return tokens.filter(t => !stop.has(t) && !black.has(t) && t.length>=2);
}
function ngramCounts(tokens, n){
  const map = new Map();
  if(tokens.length < n) return map;
  for(let i=0;i<=tokens.length-n;i++){
    const gram = tokens.slice(i,i+n).join(" ");
    map.set(gram, (map.get(gram)||0)+1);
  }
  return map;
}
function topRows(map, topK, minFreq){
  const arr = [...map.entries()].filter(([_,c])=>c>=minFreq);
  arr.sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
  return arr.slice(0, topK);
}
function renderTable(tbodyId, rows){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = rows.map(([p,c])=>`<tr><td>${escapeHtml(p)}</td><td>${c}</td></tr>`).join("");
}
function rowsToCSV(rows){
  let csv = "phrase,frequency\n";
  for(const [p,c] of rows){ csv += `"${p.replaceAll('"','""')}",${c}\n`; }
  return csv;
}

/* ----------------- Handlers ----------------- */
const fileInput = document.getElementById('fileInput');
const pasteArea = document.getElementById('pasteArea');
const inputInfo = document.getElementById('inputInfo');
const extractStatus = document.getElementById('extractStatus');
const extractedPreview = document.getElementById('extractedPreview');

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f){ return; }
  rawText = await f.text();
  inputInfo.textContent = `loaded file: ${f.name} (${(f.size/1024).toFixed(1)} KB)`;
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  fileInput.value = "";
  pasteArea.value = "";
  rawText = ""; extractedDict = null; extractedTxt = ""; caches = {bi:[], tri:[], four:[]};
  inputInfo.textContent = "no input loaded";
  extractStatus.textContent = "";
  extractedPreview.textContent = "";
  document.getElementById('tblBi').innerHTML = "";
  document.getElementById('tblTri').innerHTML = "";
  document.getElementById('tblFour').innerHTML = "";
  document.getElementById('ngStatus').textContent = "";
});

document.getElementById('runExtract').addEventListener('click', ()=>{
  const pasted = (pasteArea.value||"").trim();
  const source = (rawText && rawText.trim()) ? rawText : pasted;
  if(!source){ extractStatus.textContent = "❌ Provide a file or paste text first."; return; }
  extractedDict = extractPairs(source);
  extractedTxt = sectionedText(extractedDict);
  extractStatus.textContent = `✅ Extraction complete. title=${extractedDict.title.length}, url=${extractedDict.url.length}, snippet=${extractedDict.snippet.length}, matched_text=${extractedDict.matched_text.length}, alt=${extractedDict.alt.length}`;
  extractedPreview.textContent = extractedTxt.slice(0, 2000);
});

document.getElementById('dlExtracted').addEventListener('click', ()=>{
  if(!extractedTxt){ alert('Run extraction first.'); return; }
  blobDownload('extracted.txt', extractedTxt, 'text/plain;charset=utf-8');
});

document.getElementById('runNgrams').addEventListener('click', ()=>{
  if(!extractedDict){ alert('Run extraction first.'); return; }
  const topK = Math.max(1, parseInt(document.getElementById('topK').value||"50",10));
  const minFreq = Math.max(1, parseInt(document.getElementById('minFreq').value||"1",10));
  const extraStop = (document.getElementById('extraStop').value||"").split(',').filter(Boolean);
  const extraBlack = (document.getElementById('extraBlack').value||"").split(',').filter(Boolean);

  // Build corpus from extracted content fields, excluding URLs
  const fields = ["title","snippet","matched_text","alt"];
  const corpus = fields.map(k => (extractedDict[k]||[]).join("\n")).join("\n");
  const tokens = cleanAndTokenize(corpus, extraStop, extraBlack);

  const biMap = ngramCounts(tokens, 2);
  const triMap = ngramCounts(tokens, 3);
  const fourMap = ngramCounts(tokens, 4);

  caches.bi = topRows(biMap, topK, minFreq);
  caches.tri = topRows(triMap, topK, minFreq);
  caches.four = topRows(fourMap, topK, minFreq);

  renderTable('tblBi', caches.bi);
  renderTable('tblTri', caches.tri);
  renderTable('tblFour', caches.four);

  document.getElementById('ngStatus').textContent =
    `Done. Tokens=${tokens.length.toLocaleString()} • Unique: bi=${biMap.size}, tri=${triMap.size}, four=${fourMap.size}`;
});

document.getElementById('dlBi').addEventListener('click', ()=>{
  if(!caches.bi.length){ alert('Run N-grams first.'); return; }
  blobDownload('bigrams.csv', rowsToCSV(caches.bi), 'text/csv;charset=utf-8');
});
document.getElementById('dlTri').addEventListener('click', ()=>{
  if(!caches.tri.length){ alert('Run N-grams first.'); return; }
  blobDownload('trigrams.csv', rowsToCSV(caches.tri), 'text/csv;charset=utf-8');
});
document.getElementById('dlFour').addEventListener('click', ()=>{
  if(!caches.four.length){ alert('Run N-grams first.'); return; }
  blobDownload('fourgrams.csv', rowsToCSV(caches.four), 'text/csv;charset=utf-8');
});
</script>
</body>
</html>